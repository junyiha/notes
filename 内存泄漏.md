## Linux下C/C++程序内存泄露检查工具

+ valgrind:强大开源的程序检测工具
+ mtrace:GNU扩展,用来跟踪malloc
+ dmalloc:用于检查C/C++内存泄露的工具,即是检查是否在程序运行结束还没有释放的内存,以一个运行库发布
+ memwatch:和dmalloc一样,能够检测未释放的内存,同一段内存被释放多次,位地址取错误及不当使用未分配的内存区域
+ mpatrol:一个跨平台的C++内存泄露检测器
+ dbgmem:是一个动态库发布的形式,有点类似于dmalloc

## Valgrind详解

Valgrind包含以下一些工具:
1. Memcheck:这是valgrind应用最广泛的工具,一个重量级的内存检查器,能够发现 开发中绝大不多述的内存错误使用的情况,比如:使用未初始化
2. callgrind:主要用来检查程序中函数调用过程中出现的问题
3. cachegrind:主要用来检查程序中缓存使用出现的问题
4. Helgrind:主要用来检查多线程中出现的竞争问题
5. Massif:主要用来检查程序中堆栈使用中出现的问题
6. Extension:可以使用core提供的功能,自己编写特定的内存调试工具

内存检查原理:
1. Valid-value表:对于进程的整个地址空间中的每一个字节(byte),都有与之对应的8个bits,对于CPU的每个寄存器,也有一个与之对应的bit向量,这些bits负责记录该字节或者寄存器值是否具有有效的,已经初始化的值
2. Valid-Address表:对于进程整个地址空间中的一个字节(byte),还有与之对应的1bit,负责记录改地址是否能够被读写
3. 检测原理:
   + 当要读写内存中的某个字节时,首先检查这个字节对应的A bit, 如果该A bit显示该位置是无效位置,memcheck则报告读写错误
   + 内核(core)类似于一个虚拟的CPU环境,这样当内存中的某个字节被加载到真实的CPU中时,该字节对应的V bit也被加载到虚拟的CPU环境中,一旦寄存器中的值,被用来产生内存地址,或者该值能够影响程序的输出,则memcheck会检查对应的vbits,如果该值尚未初始化,则会报告使用未初始化内存错误

Valgrind的安装
1. 解压安装包:`tar -jxvf valgrind-3.11.0.tar.bz2 -C /usr/local/src`
2. 进入目录安装:`cd /usr/local/src/valgrind-3.11.0`
3. 运行 `./autogen.sh` 设置环境(需要标准的`autoconf`工具):`./autogen.sh`
4. 配置Valgrind,生成Makefile文件:`./configure --prefix=/usr/local`
5. 编译和安装valgrind:`make && make install`

Valgrind的使用 
+ 为了valgrind发现的错误更精确,如能够定位到源代码的行,建议在编译时加上-g参数,编译优化选项选择O0(不要优化)
+ 利用valgrind调试内存问题,不需要重新编译源程序,它的输入就是二进制的可执行程序
+ 调用valgrind的通用格式:valgrind [valgrind-options] your-program [your-program-options]
+ Valgrind的参数分为两类
    + 一类是core的参数,它对所有的工具都适用
    + 另一类就是具体某个工具,如memcheck的参数.
+ Valgrind默认的工具就是memcheck,也可以通过 `-tool=toolname` 指定其他的工具

Memcheck将内存泄露分为两种:
1. Possibly lost:可能的内存泄露
      + Possibly lost是指仍然存在某个指针能够访问某块内存,但是该指针指向的已经不是该内存的首地址
2. Definitely lost:确定的内存泄漏
      + 确定的内存泄露是指已经不能够访问这块内存
      + Definitely lost又分为两种:
          1. direct:直接,直接是没有任何指针指向该内存
          2. indirect:间接,指向该内存的指针都位于内存泄露处

Valgrind常用命令
+ `-log-file=valReport` :指定生成分析日志文件到当前执行目录,文件名为 `valReport`
+ `-leak-check=full` :显示每个泄露的详细信息
+ `-show-reachable=yes` :是否检测控制范围之外的泄露,比如全局指针,static指针等,显示所有的内存泄露类型
+ `-leak-resolution=low` :内存泄露报告合并等级

Valgrind输出内容:
+ `==98725==` :进程号,如果程序使用了多进程的方式来执行,就会显示多个进程的内容
+ 第一段是valgrind的基本信息
+ 第二段是对堆内存分配的总结信息,
+ 第三段的内容描述了内存泄露的具体信息
+ 最后一段是总结,4字节为一块的内存泄露