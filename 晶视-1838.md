## 笔记

+ `cp -r ../ubuntu1604/CV183x .`

+ `./configure.sh -c CV183X -p aarch64 -g`

+ `scp user@192.167.15.58:/home/user/workspace/vca_learn-workspace/video_process/build/test.exe ./test_enc.exe`

+ `export LD_LIBRARY_PATH=/data/picture/VideoProcess/3party/lib:/data/picture/VideoProcess/lib:/mnt/flash/Server/lib/:$LD_LIBRARY_PATH`

+ `gdbserver :9999 test_enc.exe test_ffmpeg --src forget.mp4`

+ `scp -r imgs/ user@192.167.15.58:/tmp/`

+ 通过接口使用物理设备，
+ 每一个物理设备都有一个设备号，一一对应，指定哪一个设备号就是用哪一个设备

## 概述

+ CVITEK 所提供的多媒体软件架构（Multimedia Framework， 简称 MMF），用以缩短应用程序开发所需的时间。 此架构屏蔽了芯片端的复杂底层设计和差异，对应用程序提供统一且便捷的MMF Programming Interface编程接口。 MMF 包含了以下功能： ISP 影像前处理（包含 HDR、去噪、边缘锐化等）、输入影像撷取及输出、图像几何校正、H.265/ H.264/JPEG 编解码、音频撷取及输出、音频编解码等

+ 定义及缩写
  + MMF(Multimedia Framework 多媒体软件架构)
  + ISP(Image Signal Processor 影像处理处理器)
  + VI(Video Input 影像输入)
  + VPSS(Video Process Sub-System 影像处理子系统)
  + VO(Video Output 影像输出)
  + VDEC(Video Decoder 影像解码)
  + VENC(Video Encoder 影像编码)

+ 内部主要处理流程：
  + VI 捕捉视频图像，可对其做剪切、影像优化等处理后，再将图像数据传递给VPSS 处理
  + **VDEC 将编码后的码流解码，再将图像数据传递给 VPSS 处理**
  + **VPSS 接收 VI 或 VDEC 发送的图像，并可同时输出多个不同分辨率的图像，以供预览、编码或抓拍**
  + VO 接收 VPSS 处理后的图像，并根据设定的时序输出到显示设备
  + REGION 可以将用户所指定的位图（Bitmap）作为 OSD 叠加到图像数据上

+ 系统绑定
  + SDK 提供系统绑定接口（CVI_SYS_Bind） ，即通过绑定数据源和数据接收者来建立两者之间的关联关系。 绑定后，数据源生成的数据将自动发送给接收者。 一个数据源可以绑定多个数据接收者，若数据源未绑定，则最终会自动返回视频内存区块池
  + 同一个数据接收者只能绑定一个数据源
  + VI 和 VDEC 作为数据源,是以通道为发送者,向其他模块发送数据,用户将设备号置为 0,SDK 不检查输入的设备号
  + VPSS 作为数据接收者时,是以设备(GROUP)为接收者,接收其他模块发来的数据,用户将通道号置为 0
  + 其他情况均需指定设备号和通道号

## VDEC VO

+ VDEC模块提供驱动视频解码硬件工作的对应接口，实现**视频解码功能**

+ 定义及缩写
  + VDEC            -- Video Decoder，视频解码器
  + Output Order    -- 输出顺序
  + Decoding Order  -- 解码顺序
  + Displayer Order -- 播放顺序
  + Frame           -- 帧
  + Stream          -- 码流

+ 图像输出方式
  + 按照H.264/H.265视频标准，输入的Stream经解码之后，输出的影像顺序未必等于输入的顺序，因此在播放时会分为Decoding order 和 Display order
    + Decoding order -- 输出影像的顺序等于输入Stream的顺序
    + Display Order  -- 输出影像的顺序等于最后播放的顺序

## 结构体

+ VDEC_CHN_ATTR_S
  + 273页

--------------------------------------------------------------------------------------------------------------------------------

## 视频解码(VDEC) -- API参考

+ 文档256页

### CVI_VDEC_CreateChn

+ 原型：`CVI_S32 CVI_VDEC_CreateChn(VDEC_CHN VdChn, const VDEC_CHN_ATTR_S *pstAttr);`
+ 参数：
  + CVI_S32  -- typedef int CVI_S32
  + VdChn  --  输入， 视频解码通道号
  + pstAttr -- 输入， 解码通道属性指针
+ 返回值：
  + CVI_SUCCESS 成功
  + 非0         失败，其值为错误码
+ 需求：
  + cvi_vdec.h  cvi_comm_video.h  cvi_comm_vdec.h
  + libvdec.so / libvdec.a
+ 注意
  + 系统内存不足时，返回`HI_ERR_VDEC_NOMEM` 错误码
  + **使用JPEG/MJPEG时**，要在创建解码信道（通道）之前要先创建专属于VDEC的模块VB池，不同协议解码所需要的图像VB块大小不同，参考`sample_vdec_lib.c`内的`vdecInitVBPool`函数
  + **H264 H265内核已经保留了memory， 所以不需要调用VB函数**
+ 示例代码：
  + `/sample/common/sample_common_vdec.c:720:`

### CVI_VDEC_DestoryChn

+ 原型：`CVI_S32 CVI_VDEC_DestoryChn(VDEC_CHN VdChn);`
+ 参数：
  + VdChn -- 视频解码通道号 - 输入
+ 返回值
  + CVI_SUCCESS -- 成功
  + 非0         -- 失败，其值为错误码
+ 需求：
  + cvi_vdec.h  cvi_comm_video.h  cvi_comm_vdec.h
  + libvdec.so / libvdec.a
+ 注意
  + 销毁前必须保证通道已经创建，否则会返回通道未创建错误
  + 销毁前必须停止接收码流（或者尚未开始接收码流）否则返回错误

### CVI_VDEC_GetChnAttr

+ 原型：`CVI_S32 CVI_VDEC_GetChnAttr(VDEC_CHN VdChn, VDEC_CHN_ATTR_S *pstAttr)`
+ 功能：获取视频解码通道属性
+ 参数：
  + VdChn  -- 视频解码通道号  -- 输入
  + pstAttr -- 解码通道属性指针 -- **输出**
+ 返回值
  + CVI_SUCCESS -- 成功
  + 非0         -- 失败，其值为错误码
+ 需求：
  + cvi_vdec.h  cvi_comm_video.h  cvi_comm_vdec.h
  + libvdec.so / libvdec.a
+ 注意
  + VDEC通道必须已经创建
  + 此函数通常在CVI_VDEC_SetChnAttr前使用，或者是在获取decoder frame之前调用，以确认通道正常
+ 举例
  + `sample_common_vdec.c`内的`SAMPLE_COMM_VDEC-GetPic()`函数（587）

### CVI_VDEC_SetChnAttr

+ 原型：`CVI_S32 CVI_VDEC_SetChnAttr(VDEC_CHN VdChn, const VDEC_CHN_ATTR_S *pstAttr);`
+ 功能：设置视频解码通道属性
+ 参数：
  + VdChn  -- 视频解码通道号 -- 输入
  + pstAttr -- 解码通道属性指针 -- 输入
+ 返回值
  + CVI_SUCCESS -- 成功
  + 非0         -- 失败，其值为错误码
+ 需求：
  + cvi_vdec.h  cvi_comm_video.h  cvi_comm_vdec.h
  + libvdec.so / libvdec.a
+ 注意：
  + VDEC通道必须已经创建
  + 切换通道属性之前必须先停止接收码流，否则返回错误

### CVI_VDEC_StartRecvStream

+ 原型：`CVI_S32 CVI_VDEC_StartRecvStream(VDEC_CHN VdChn);`
+ 功能：解码器开始接收用户发送的码流
+ 参数
  + VdChn  -- 视频解码通道号  -- 输入
+ 返回值
  + CVI_SUCCESS -- 成功
  + 非0         -- 失败，其值为错误码
+ 需求：
  + cvi_vdec.h  cvi_comm_video.h  cvi_comm_vdec.h
  + libvdec.so / libvdec.a
+ 注意
  + 启动接收码流前必须保证通道已经创建，否则会返回错误

### CVI_VDEC_StopRecvStream

+ 原型：`CVI_S32 CVI_VDEC_StopRecvStream(VDEC_CHN VdChn);`
+ 功能：解码器停止接收用户发送的码流
+ 参数
  + VdChn  -- 视频解码通道号  -- 输入
+ 返回值
  + CVI_SUCCESS -- 成功
  + 非0         -- 失败，其值为错误码
+ 需求：
  + cvi_vdec.h  cvi_comm_video.h  cvi_comm_vdec.h
  + libvdec.so / libvdec.a
+ 注意
  + 调用此接口，必须在CVI_VDEC_DestoryChn之前

### CVI_VDEC_QueryStatus

+ 原型：`CVI_S32 CVI_VDEC_QueryStatus(VDEC_CHN VdChn, VDEC_CHN_STATUS_S *pstStatus);`
+ 功能：查询解码通道状态
+ 参数
  + VdChn  -- 视频解码通道号  -- 输入
  + pstStatus  -- 视频解码通道状态结构体指针  -- **输出**
+ 返回值
  + CVI_SUCCESS -- 成功
  + 非0         -- 失败，其值为错误码
+ 需求：
  + cvi_vdec.h  cvi_comm_video.h  cvi_comm_vdec.h
  + libvdec.so / libvdec.a
+ 注意
  + 启动接收码流前必须保证通道已经创建，否则会返回错误
+ 参阅`sample_common_vdec.c`内的`SAMPLE_COMM_VDEC_CmdCtrl`用法

### CVI_VDEC_SetChnParam

+ 原型：`CVI_S32 CVI_VDEC_SetChnParam(VDEC_CHN VdChn, const VDEC_CHN_PARAM_S *pstPrarm);`
+ 功能：设置解码通道参数
+ 参数
  + VdChn  -- 视频解码通道号 -- 输入
  + pstParaqm  --  通道参数  -- 输入
+ 返回值
  + CVI_SUCCESS -- 成功
  + 非0         -- 失败，其值为错误码
+ 需求：
  + cvi_vdec.h  cvi_comm_video.h  cvi_comm_vdec.h
  + libvdec.so / libvdec.a
+ 注意
  + 启动接收码流前必须保证通道已经创建，否则会返回错误

### CVI_VDEC_GetChnParam

+ 原型：`CVI_S32 CVI_VDEC_GetChnParam(VDEC_CHN VdChn, const VDEC_CHN_PARAM_S *pstPrarm);`
+ 功能：获取解码通道参数
+ 参数
  + VdChn  -- 视频解码通道号 -- 输入
  + pstParaqm  --  通道参数  -- **输出**
+ 返回值
  + CVI_SUCCESS -- 成功
  + 非0         -- 失败，其值为错误码
+ 需求：
  + cvi_vdec.h  cvi_comm_video.h  cvi_comm_vdec.h
  + libvdec.so / libvdec.a
+ 注意
  + 启动接收码流前必须保证通道已经创建，否则会返回错误

### CVI_VDEC_SendStream

+ 原型：`CVI_S32 CVI_VDEC_SendStream(VDEC_CHN VdChn, const VDEC_STREAM_S *pstStream, CVI_S32 s32MilliSec);`
+ 功能：发送码流数据至视频解码通道
+ 参数：
  + VdChn  -- 视频解码通道号 -- 输入
  + pstStream  -- 解码码流数据指针 -- 输入
  + s32MilliSec  -- 送码流方式标志  -- 输入  
    + 取址范围： -1， 阻塞
+ 返回值
  + CVI_SUCCESS -- 成功
  + 非0         -- 失败，其值为错误码
+ 需求：
  + cvi_vdec.h  cvi_comm_video.h  cvi_comm_vdec.h
  + libvdec.so / libvdec.a
+ 注意
  + 发送数据前必须保证已经调用`CVI_VDEC_CreateChn`, `CVI_VDEC_StartRecvStream`
  + 此接口在mjpeg， jpeg译码状态下，送入长度0（pstStream->u32Len)会返回CVI_SUCCESS
  + 译码失败会回传错误码：`ERR_CVI_VDEC_SEND_STREAM`

### CVI_VDEC_GetFrame

+ 原型：`CVI_S32 CVI_VDEC_GetFrame(VDEC_CHN VdChn, VIDEO_FRAME_INFO_S *pstFrameInfo, CVI_S32 s32MilliSec);`
+ 功能：获取视频解码通道的解码图像
+ 参数：
  + VdChn         -- 视频解码通道号     -- 输入
  + s32MilliSec   -- 获取图像方式标志   -- 输入
    + 取值范围： -1 ， 阻塞
  + pstFrameInfo  -- 获取的解码图像信息  -- 输出
+ 返回值
  + CVI_SUCCESS   -- 成功
  + 非0           -- 失败，其值为错误码
+ 需求：
  + cvi_vdec.h  cvi_comm_video.h  cvi_comm_vdec.h
  + libvdec.so / libvdec.a
+ 注意
  + 启动接收码流前必须保证通道已经创建，否则会返回错误

### CVI_VDEC_ReleaseFrame

+ 原型：`CVI_S32 CVI_VDEC_ReleaseFrame(VDEC_CHN VdChn, const VIDEO_FRAME_INFO_S *pstFrameInfo);`
+ 功能：释放视频解码通道的图像
+ 参数
  + VdChn         -- 视频解码通道号       -- 输入
  + pstFrameInfo  -- 解码后的图像信息指针  -- 输入
+ 返回值
  + CVI_SUCCESS   -- 成功
  + 非0           -- 失败，其值为错误码
+ 需求：
  + cvi_vdec.h  cvi_comm_video.h  cvi_comm_vdec.h
  + libvdec.so / libvdec.a
+ 注意：
  + 此接口需要和CVI_VDEC_GetFrame配对使用，获取的数据应当在使用完之后立即释放，如果不立即释放，会导致解码过程阻塞等待资源
  + 释放的数据必须是CVI_VDEC_GetFrame从该通道获取的数据，不得对数据信息结构体进行任何修改
  + 释放视频解码通道的图像必须在通道销毁之前。

--------------------------------------------------------------------------------------------------------------------------------

## 视频处理子系统(VPSS) -- API参考

### CVI_VPSS_GetChnFrame

+ 原型:`CVI_S32 CVI_VPSS_GetChnFrame(VPSS_GRP VpssGrp, VPSS_CHN VpssChn, VIDEO_FRAME_INFO_S *pstFrameInfo, CVI_S32 s32MilliSec);`
+ 功能:用户从通道获取一帧处理完成的图像
+ 参数:
  + VpssGrp  -- VPSS GROUP 号,取值范围:`[0,VPSS_MAX_GRP_NUM]`  -- 输入
  + VpssChn  -- VPSS 通道号，取值范围:`[0,VPSS_MAX_CHN_NUM]`    -- 输入
  + pstVideoFrame  -- 待发送的图像信息（详解在系统控制章节）  -- **输出**
  + s32MilliSec  --  超时时间  -- 输入
+ 返回值:
  + CVI_SUCCESS   -- 成功
  + 非0           -- 失败，其值为错误码
+ 需求:
  + 头文件:cvi_comm_vpss.h、cvi_vpss.h
  + 库文件:libvpu.a
+ 注意:
  + Group 必须已经创建
  + **该函数将获得的图像信息保存在 pstvideoFrame 里面,并包含了图像的虚拟地址和物理地址**

+ `VENC_CHN_ATTR_S::VENC_ATTR_S`:决定编码属性,此属性决定编码协议并赋值设定对应宽，高