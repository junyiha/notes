## 简介

+ rk平台软件版本发行

## mnc 守护进程

+ 更新source源为清华源
+ apt下载python3-dev python3-pip
+ python3下载psutil
+ 拷贝watch_thread.py和restart_mnc.sh到/data/static/bash/
+ 更新/data/static/bash/auto-start.sh,增加 python3 /data/static/bash/watch_thread.py

## ip配置服务

+ 软件路径: /mnt/remote/190-mnt/zhangpengcheng/Release/abcdk/latest

```bash
chmod +x /data/abcdk/init.d/start-ipconfig.sh
/data/abcdk/init.d/start-ipconfig.sh
```

+ 脚本
```bash 
#! /bin/bash 

path="/mnt/remote/190-mnt/zhangpengcheng/Release/abcdk/latest/1.7/"
program="abcdk-1.7.9-arm-linux-gnueabihf.tar.gz"

scp user@192.169.4.16:${path}${program} /userdata/

cd /userdata/

pwd

echo "tar -zxf ${program}"

eval "tar -zxf ${program}"

rm ${program}
```

## frpc服务

+ 软件路径: /mnt/remote/190-mnt/zhangpengcheng/Release/Help/FRP/

```bash
chmod +x /userdata/frp_0.52.3_linux_arm/frp_start.sh
nohup /userdata/frp_0.52.3_linux_arm/frp_start.sh &
```

+ frp_start.sh
```bash
#! /bin/bash 

sleep 60

# for frp
function FRPC()
{
	frpc="/userdata/frp_0.52.3_linux_arm/frpc"
	config="/userdata/frp_0.52.3_linux_arm/frpc.toml"

	# eval "nohup ${frpc} -c ${config} > /dev/null 2>&1 &"
	route > /tmp/route.log &
	eval "nohup ${frpc} -c ${config} > /tmp/frpc.log &"
}

FRPC
```

## mnc script

```bash
#! /bin/bash 

# 创建任务
curl --location --request POST 'http://127.0.0.1:8000/api/setting/task/add' \
--header 'User-Agent: Apifox/1.0.0 (https://apifox.com)' \
--header 'Content-Type: application/json' \
--header 'Accept: */*' \
--header 'Host: 192.169.5.61:8000' \
--header 'Connection: keep-alive' \
--data-raw '{
    "name":"安全帽检测",
    "start":1,
    "source":10,
    "schedulerType":"Daemon",
    "models":{
        "id":3,
        "duration":" ",
        "start":" ",
        "end":" "
    }
}'

# 停止任务
curl -X POST --data "{\"id\":\"Qk99V\"}" http://127.0.0.1:8000/api/setting/task/stop

# 删除任务
curl -X POST --data "{\"ids\":[\"qfNY7\"]}" http://127.0.0.1:8000/api/setting/task/delete

# 启动任务
curl -X POST --data "{\"id\":\"Qk99V\"}" http://127.0.0.1:8000/api/setting/task/start

# 任务列表
curl -X GET http://127.0.0.1:8000/api/setting/task/list

# 相机列表
curl -X GET http://127.0.0.1:8000/api/setting/camera/list

# 创建相机
curl --location --request POST 'http://127.0.0.1:8000/api/setting/camera/add' \
--header 'User-Agent: Apifox/1.0.0 (https://apifox.com)' \
--header 'Content-Type: application/json' \
--header 'Accept: */*' \
--header 'Host: 192.169.5.61:8000' \
--header 'Connection: keep-alive' \
--data-raw '{
    "name": "安全帽",
    "url":"rtsp://admin:qdek2018@192.168.0.51:554/h265/ch1/main/av_stream"
}'

# 清除所有告警记录并删除文件
curl -X GET http://127.0.0.1:8000/api/setting/warning_record/clear

# 查看最新告警
curl --location --request POST 'http://127.0.0.1:8000/api/setting/warning_record/latest' \
--header 'User-Agent: Apifox/1.0.0 (https://apifox.com)' \
--header 'Content-Type: application/json' \
--header 'Accept: */*' \
--header 'Host: 127.0.0.1:8000' \
--header 'Connection: keep-alive' \
--data-raw '{
    "count": 20
}'

# 算法列表
curl -X GET http://127.0.0.1:8000/api/setting/algorithm/list

# 管理平台列表
curl -X GET http://127.0.0.1:8000/api/device/listCloudPlatform

# 创建管理平台
curl --location --request POST 'http://127.0.0.1:8000/api/device/addCloudPlatform' \
--header 'User-Agent: Apifox/1.0.0 (https://apifox.com)' \
--header 'Content-Type: application/json' \
--header 'Accept: */*' \
--header 'Host: 192.169.5.61:8000' \
--header 'Connection: keep-alive' \
--data-raw '{
    "name": "test112",
    "type": "event_push",
    "address": "https://wisdom.aotusoft.net/wisdom/aibox/upload",
    "appKeyId": "afa",
    "appKeySecret": "1111"
}'

curl -X GET http://127.0.0.1:8000/api/device/info

```

## vca script

```bash
#! /bin/bash 

# 任务列表
curl -X POST --data-urlencode 'cmd=1' http://127.0.0.1:17008/api

# 查询任务状态
curl -X POST --data-urlencode 'cmd=6' --data-urlencode 'id=79Tli' http://127.0.0.1:17008/api

# 删除任务
curl -X POST --data-urlencode 'cmd=4' --data-urlencode 'id=40gA9' http://127.0.0.1:17008/api
```

## ffmpeg record video

+ 视频录制
```bash
# clear ssh known hosts
ssh-keygen -f "/home/user/.ssh/known_hosts" -R "47.100.31.121"

# update environment
source /data/static/bash/source.sh

# gh-rk-1012
/data/edge/VideoProcess/3party/bin/ffmpeg -rtsp_transport tcp -i rtsp://127.0.0.1:554/live/ZbrZW -c copy -an -f mp4 -t 00:01:00 /userdata/zzz.mp4

# gh-rk-1008
/data/edge/VideoProcess/3party/bin/ffmpeg -rtsp_transport tcp -i rtsp://127.0.0.1:554/live/Vr3fq -c copy -an -f mp4 -t 00:01:00 /userdata/vvv.mp4
/data/edge/VideoProcess/3party/bin/ffmpeg -rtsp_transport tcp -i rtsp://127.0.0.1:554/live/Lqsnr -c copy -an -f mp4 -t 00:01:00 /userdata/vvv.mp4
```

+ 视频拷贝
```bash
# gh-rk-1012
ls /home/user/zjy-190/Videos/gh-rk-1012/
mv /home/user/zjy-190/Videos/gh-rk-1012/zzz.mp4 /home/user/zjy-190/Videos/gh-rk-1012/zzz_7.mp4
scp -o 'proxycommand socat - PROXY:47.100.31.121:gh-rk-1012:22,proxyport=5002' root@47.100.31.121:/userdata/zzz.mp4 /home/user/zjy-190/Videos/gh-rk-1012/
ffplay /home/user/zjy-190/Videos/gh-rk-1012/zzz.mp4

# gh-rk-1008
ls /home/user/zjy-190/Videos/gh-rk-1008/
mv /home/user/zjy-190/Videos/gh-rk-1008/vvv.mp4 /home/user/zjy-190/Videos/gh-rk-1008/vvv_2.mp4
scp -o 'proxycommand socat - PROXY:47.100.31.121:gh-rk-1008:22,proxyport=5002' root@47.100.31.121:/userdata/vvv.mp4 /home/user/zjy-190/Videos/gh-rk-1008/
ffplay /home/user/zjy-190/Videos/gh-rk-1008/vvv.mp4
```