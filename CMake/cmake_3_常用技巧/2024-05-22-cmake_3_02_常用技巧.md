---
category: CMake
date: 2024-05-22 09:00:00 +0800
layout: post
title: cmake_3_02_常用技巧
tag: CMake
---
## 简介

+ cmake 常用的技巧

## cmake 子项目设置二进制文件保存路径

要设置子项目的二进制文件保存路径，你可以在使用 `add_subdirectory()` 函数添加子项目时，通过第二个参数 `binary_dir` 来指定。

假设你有如下的项目结构：

```
project_root/
    CMakeLists.txt
    src/
        CMakeLists.txt
        file1.cpp
        file2.cpp
    test/
        CMakeLists.txt
        test1.cpp
        test2.cpp
```

如果你希望将子项目的二进制文件保存在不同的目录中，可以像这样在父项目的 `CMakeLists.txt` 中设置：

```cmake
cmake_minimum_required(VERSION 3.10)
project(MyProject)

add_subdirectory(src bin/src)
add_subdirectory(test bin/test)
```

在这个例子中，`src` 子项目的二进制文件将保存在 `project_root/bin/src` 目录中，而 `test` 子项目的二进制文件将保存在 `project_root/bin/test` 目录中。

如果不指定 `binary_dir` 参数，子项目的二进制文件将默认保存在子项目目录下的 `bin` 目录中。

## cmake 在子项目中设置头文件包含目录

在 CMake 中，你可以在子项目中使用 `target_include_directories()` 函数来设置头文件包含目录。这个函数用于为指定的目标（例如库或可执行文件）设置头文件搜索路径。假设你有如下的项目结构：

```
project_root/
    CMakeLists.txt
    src/
        CMakeLists.txt
        file1.cpp
        file2.cpp
        include/
            header1.h
            header2.h
    test/
        CMakeLists.txt
        test1.cpp
        test2.cpp
```

在 `src/CMakeLists.txt` 中，你可以这样设置头文件包含目录：

```cmake
target_include_directories(my_target_name PUBLIC ${CMAKE_CURRENT_SOURCE_DIR}/include)
```

在这个例子中，`my_target_name` 是你在 `src/CMakeLists.txt` 中定义的目标名称，`${CMAKE_CURRENT_SOURCE_DIR}` 表示当前源码目录的路径，`${CMAKE_CURRENT_SOURCE_DIR}/include` 就是 `include` 目录的路径。使用 `PUBLIC` 关键字可以将这个头文件包含目录设置为公开的，这意味着这个目录将会被导出到依赖这个目标的其他目标中。

在 `test/CMakeLists.txt` 中，你也可以类似地设置头文件包含目录：

```cmake
target_include_directories(test_target_name PRIVATE ${CMAKE_CURRENT_SOURCE_DIR}/../src/include)
```

在这个例子中，`test_target_name` 是你在 `test/CMakeLists.txt` 中定义的目标名称，`${CMAKE_CURRENT_SOURCE_DIR}/../src/include` 是相对于 `test` 目录的父目录 `src/include` 的路径。使用 `PRIVATE` 关键字可以将这个头文件包含目录设置为私有的，这意味着这个目录只对当前目标有效，不会被导出到依赖当前目标的其他目标中。

## cmake 打印目标的头文件路径和编译选项

要打印目标的头文件路径和编译选项，您可以使用 `get_target_property` 命令来获取目标的属性。以下是一个示例代码，假设您的目标名为 `my_target`：

```cmake
# 获取目标的头文件路径
get_target_property(TARGET_INCLUDE_DIRECTORIES my_target INCLUDE_DIRECTORIES)
message(STATUS "My target include directories: ${TARGET_INCLUDE_DIRECTORIES}")

# 获取目标的编译选项
get_target_property(TARGET_COMPILE_OPTIONS my_target COMPILE_OPTIONS)
message(STATUS "My target compile options: ${TARGET_COMPILE_OPTIONS}")
```

这段代码将打印出目标 `my_target` 的头文件路径和编译选项。您可以根据需要获取和打印其他属性。

## cmake find_package 配置opencv库

配置 OpenCV 库时，通常会使用 CMake 的 `find_package` 命令。以下是一个简单的示例，展示如何在 CMake 中配置和链接 OpenCV 库：

```cmake
cmake_minimum_required(VERSION 3.12)
project(MyProject)

# 使用 find_package 查找并配置 OpenCV 库
find_package(OpenCV REQUIRED)

# 输出找到的 OpenCV 库信息
message("OpenCV_INCLUDE_DIRS: ${OpenCV_INCLUDE_DIRS}")
message("OpenCV_LIBRARIES: ${OpenCV_LIBRARIES}")

# 添加可执行文件，并链接 OpenCV 库
add_executable(MyExecutable main.cpp)
target_include_directories(MyExecutable PRIVATE ${OpenCV_INCLUDE_DIRS})
target_link_libraries(MyExecutable PRIVATE ${OpenCV_LIBRARIES})
```

在上述代码中：

- `find_package(OpenCV REQUIRED)` 用于查找并配置 OpenCV 库。`REQUIRED` 表示如果找不到 OpenCV 库，将产生一个错误。
- `OpenCV_INCLUDE_DIRS` 包含了 OpenCV 库的头文件目录。
- `OpenCV_LIBRARIES` 包含了 OpenCV 库的链接库的名称。
- `add_executable` 添加了一个可执行文件，并使用 `target_include_directories` 将 OpenCV 库的头文件目录包含进来，使用 `target_link_libraries` 将 OpenCV 库链接到可执行文件中。

确保 OpenCV 已经安装在你的系统中，或者你可以使用 CMake 的 `ExternalProject` 或其他方法在 CMake 中构建 OpenCV。

此外，`find_package` 还可以通过指定版本号和特定组件来细化查找过程。例如：

```cmake
find_package(OpenCV 4.5.1 REQUIRED COMPONENTS core imgproc highgui)
```

这将查找并配置 OpenCV 版本为 4.5.1，并确保包含了 core、imgproc 和 highgui 组件。

## cmake find_package 配置gflags库

当使用 CMake 的 `find_package` 配置 `gflags` 库时，你需要确保 `gflags` 库的 CMake 模块文件 `Findgflags.cmake` 被正确找到并使用。以下是一个简单的例子，演示如何在 CMake 中使用 `find_package` 配置 `gflags` 库：

```cmake
cmake_minimum_required(VERSION 3.12)
project(MyProject)

# 使用 find_package 查找 gflags 库
find_package(gflags REQUIRED)

# 输出找到的 gflags 库信息
message("gflags_INCLUDE_DIRS: ${gflags_INCLUDE_DIRS}")
message("gflags_LIBRARIES: ${gflags_LIBRARIES}")

# 添加可执行文件，并链接 gflags 库
add_executable(MyExecutable main.cpp)
target_link_libraries(MyExecutable PRIVATE gflags)
```

在上述代码中：

- `find_package(gflags REQUIRED)` 用于查找并配置 `gflags` 库。`REQUIRED` 表示如果找不到 gflags 库，将产生一个错误。
- `gflags_INCLUDE_DIRS` 包含了 `gflags` 库的头文件目录。
- `gflags_LIBRARIES` 包含了 `gflags` 库的链接库的名称。
- `add_executable` 添加了一个可执行文件，并使用 `target_link_libraries` 将 `gflags` 库链接到可执行文件中。

确保 `gflags` 库已经安装在系统中，或者你可以使用 `ExternalProject` 或其他方法在 CMake 中构建 `gflags`。

此外，如果你的项目中还用到其他外部库，可能需要在 `find_package` 后面添加其他库的查找，以确保这些库的依赖关系也得到正确配置。

最后，记得在 `CMakeLists.txt` 中引入 `main.cpp` 或其他源代码文件，以确保它们被编译到可执行文件中。