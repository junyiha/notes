---
category: Cpp
date: 2024-07-02 09:00:00 +0800
layout: post
title: RTSP视频流
tag: Tools
---
## rtsp视频流是什么

RTSP（Real-Time Streaming Protocol，即实时流传输协议）是一种网络协议，用于控制音频或视频流的传输。RTSP允许客户端从服务器请求媒体流并进行播放、暂停、停止等操作。它通常用于IP摄像头、直播流媒体服务器和其他需要实时流传输的应用场景。

RTSP协议的主要特点包括：

1. **实时性**：RTSP适用于需要实时传输音视频的应用，如直播和视频会议。
2. **控制性**：RTSP允许客户端对流媒体进行控制，例如开始、暂停、停止和快进。
3. **独立于传输**：RTSP可以与各种传输协议（如RTP、UDP、TCP等）结合使用，以适应不同的网络环境。
4. **灵活性**：RTSP可以支持不同的媒体格式和传输机制，使其适应各种应用需求。

常见的RTSP使用场景包括：

- 网络摄像头（IP摄像头）的实时视频监控
- 流媒体服务器的直播传输
- 视频点播（VoD）服务

RTSP流的典型URL格式如下：

```
rtsp://[用户名]:[密码]@[IP地址]:[端口]/[路径]
```

例如：

```
rtsp://user:password@192.168.1.100:554/stream1
```

这表示客户端可以使用RTSP协议连接到IP地址为192.168.1.100的服务器，端口为554，并请求路径为`/stream1`的媒体流。

## 实时传输协议RTP与RTCP

+ RTP(Real-time Transport Protocol)是用于Internet上针对多媒体数据流的一种传输协议。
+ RTP协议是建立在UDP协议上的。RTP协议详细说明了在互联网上传递音频和视频的标准数据包格式。RTP协议常用于流媒体系统(配合RTCP协议)，视频会议和视频电话系统(配合H.263或SIP)
+ RTP本身并没有提供按时发送机制或其他服务质量(Qos)保证，它依赖于底层服务去实现这一过程。RTP并不保证传送或防止无序传送，也不确定底层网络的可靠性。
+ RTP中的序列号允许接收方重组发送方的包序列，同时序列号也能用于决定适当的包位置，例如：在视频解码中，就不需要顺序解码。

+ 实时传输控制协议(Real-time Transport Control Protocol, RTCP)是实时传输协议(RTP)的一个姐妹协议。RTCP为RTP媒体流提供信道外控制。RTCP定期在流媒体会话参加者之间传输控制数据。
+ RTCP的主要功能是为RTP所提供的服务质量提供反馈。RTCP收集相关媒体连接的统计信息，例如：传输字节数，传输分组数，丢失分组数，时延抖动，单向和双向网络延迟等等。
+ 网络应用程序可以利用RTCP所提供的信息试图提高服务质量，比如限制信息流量或改用压缩比较小的编解码器。RTCP本身不提供数据加密或身份认证，其伴生协议STRCP(安全实时传输控制协议)则可以用于此类用途。

## RTP协议是什么

RTP（Real-time Transport Protocol，即实时传输协议）是一种网络协议，专门用于通过IP网络传输实时音视频数据。它是由IETF（Internet Engineering Task Force）定义的标准协议，用于在互联网上传输实时媒体流。

RTP协议的主要特点和功能包括：

1. **实时传输**：RTP适用于需要低延迟的实时应用，如视频会议、IP电话和流媒体播放。
2. **数据包封装**：RTP将音视频数据封装成数据包，以便在网络上传输。每个RTP包包含一个序列号和时间戳，用于保证数据包的顺序和同步。
3. **传输质量监控**：RTP通常与RTCP（Real-time Transport Control Protocol，即实时传输控制协议）一起使用。RTCP提供了传输质量的反馈信息，如丢包率、延迟和抖动等，帮助优化传输质量。
4. **灵活性**：RTP支持各种音视频编解码器和媒体格式，使其适用于不同类型的媒体流。

RTP通常与其他协议一起使用，如：

- **RTSP（实时流传输协议）**：用于控制RTP流的传输。
- **SIP（会话发起协议）**：用于建立、修改和终止多媒体会话，如IP电话。
- **SDP（会话描述协议）**：用于描述多媒体会话的参数，包括媒体类型、格式、传输地址和端口等。

一个典型的RTP数据包结构如下：

- **版本号**：指示RTP版本。
- **序列号**：用于标识数据包的顺序。
- **时间戳**：用于同步音视频流。
- **有效负载类型**：指示数据包中承载的媒体类型和编码方式。
- **源标识符（SSRC）**：唯一标识发送RTP流的源。

通过这些特性，RTP能够确保实时音视频数据的有效传输和同步，从而在互联网上提供高质量的实时多媒体通信。

## RTCP协议是什么

RTCP（Real-time Transport Control Protocol，即实时传输控制协议）是一种网络协议，用于与RTP（Real-time Transport Protocol，即实时传输协议）一起工作，提供对实时数据流传输质量的监控和控制。RTCP并不传输媒体数据本身，而是传输控制信息，帮助管理和优化媒体传输。

RTCP的主要功能包括：

1. **传输质量反馈**：RTCP提供有关传输质量的反馈信息，如数据包丢失率、延迟和抖动。这些信息可以帮助发送方和接收方调整传输参数，以提高传输质量。

2. **参与者标识**：RTCP允许每个参与者报告其标识信息，如名称和邮箱地址。这有助于在多方通信中识别各个参与者。

3. **带宽管理**：RTCP可以帮助控制会话的带宽使用。通过反馈信息，发送方可以调整传输速率，以避免网络拥塞。

4. **同步多媒体流**：RTCP可以协助同步来自不同源的多个RTP流（如音频和视频），以确保它们在接收端正确地同步播放。

RTCP报文类型主要有以下几种：

1. **SR（Sender Report，发送报告）**：由RTP流的发送者定期发送，包含发送的RTP包数和字节数，以及与接收者同步的时间信息。

2. **RR（Receiver Report，接收报告）**：由RTP流的接收者定期发送，包含接收到的RTP包数、丢包率、往返时间等统计信息。

3. **SDES（Source Description Items，源描述项）**：包含源标识符和相关的文本信息（如参与者的名字）。

4. **BYE**：通知结束会话的消息，表示发送者将退出会话。

5. **APP（Application Specific Message，应用特定消息）**：用于传输特定应用定义的控制信息。

通过与RTP一起使用，RTCP能够提供有效的传输控制和质量管理，确保实时媒体流的传输质量和可靠性。这使得RTCP成为多媒体通信中不可或缺的协议之一。

## 实时消息传输协议RTMP

RTMP（Real-Time Messaging Protocol，即实时消息传输协议）是一种由Adobe Systems开发的协议，主要用于在互联网或局域网上进行音频、视频和数据的实时传输。RTMP最初用于支持Adobe Flash播放器，但现已被广泛用于各种流媒体传输应用，尤其是在直播流媒体中。

RTMP的主要特点和功能包括：

1. **低延迟传输**：RTMP能够实现低延迟的音视频数据传输，这使其非常适用于直播和实时互动场景。
2. **持续连接**：RTMP通过TCP连接传输数据，保持与服务器的持久连接，以确保数据的可靠传输和最小化延迟。
3. **多路复用**：RTMP支持将音频、视频和控制信息多路复用在一个TCP连接上，从而简化了传输过程。
4. **灵活性**：RTMP支持多种音频和视频编解码器，包括H.264和AAC，这使其能够适应不同的媒体格式和质量要求。
5. **控制消息**：RTMP支持多种控制消息，如暂停、播放、停止等，以便对流媒体进行实时控制。

RTMP的传输过程通常分为三个阶段：

1. **握手阶段**：客户端和服务器通过交换握手消息建立连接，并协商通信参数。
2. **连接阶段**：客户端向服务器发送连接请求，并建立会话。
3. **数据传输阶段**：客户端和服务器之间开始传输音视频数据和控制消息。

RTMP有几个变种，包括：

- **RTMPT（RTMP Tunneled）**：通过HTTP进行封装，以绕过防火墙。
- **RTMPS（RTMP Secure）**：使用SSL/TLS加密的RTMP，提供安全的数据传输。
- **RTMPE（RTMP Encrypted）**：使用Adobe的加密机制进行加密，提供安全的数据传输。

一个典型的RTMP URL格式如下：

```
rtmp://[服务器IP或域名]/[应用名称]/[流名称]
```

例如：

```
rtmp://live.example.com/app/stream
```

这表示客户端可以使用RTMP协议连接到`live.example.com`服务器，请求`app`应用中的`stream`流。

尽管RTMP已经不再是主流，但它仍然在许多直播平台和视频传输系统中使用。现代替代方案如HLS（HTTP Live Streaming）和DASH（Dynamic Adaptive Streaming over HTTP）在许多新应用中更为常见。

+ RTMP是Adobe Systems公司为Flash播放器和服务器之间音频，视频和数据传输开发的开放协议。它有三种变种
  + 工作在TCP之上的明文协议，使用端口1935
  + RTMPT封装在HTTP请求之中，可穿越防火墙
  + RTMPS类似RTMPT，但使用的是HTTPS连接

+ RTMP视频播放的特点是
  + RTMP协议是采用实时的流式传输，所以不会缓存文件到客户端，这种特性说明用户想下载RTMP协议下的视频是比较难的。
  + 视频流可以随意拖动，既可以从任意时间点向服务器发送请求进行播放，并不需要视频有关键帧。相比而言，HTTP协议下视频需要有关键帧才可以随意拖动
  + RTMP协议支持点播/回放(通俗点讲，就是支持把flv, f4v, mp4文件放在RTMP服务器，客户端可以直接播放)，直播(边录制视频边播放)

## HLS

HLS（HTTP Live Streaming，即HTTP实时流传输协议）是一种基于HTTP的流媒体传输协议，由苹果公司开发。HLS最早在2009年与iOS 3.0一起发布，现已成为一种广泛使用的流媒体传输标准，适用于直播和点播视频。

HLS的主要特点和功能包括：

1. **基于HTTP**：HLS使用标准的HTTP协议传输数据，因此能够通过现有的HTTP基础设施（如CDN和HTTP缓存服务器）进行流媒体分发。
2. **分片传输**：HLS将媒体内容分割成小的时间片段（通常是几秒钟的长度），每个片段以单独的HTTP请求进行传输。这种分片传输方式可以更好地适应网络波动，提供更流畅的观看体验。
3. **自适应比特率**：HLS支持自适应比特率传输，客户端可以根据当前的网络状况动态选择不同质量的媒体片段，从而在网络带宽变化时提供最佳的观看体验。
4. **跨平台支持**：HLS不仅支持苹果设备（如iPhone、iPad和Apple TV），还可以在其他操作系统和设备上使用，包括Android设备、智能电视和Web浏览器。
5. **简单实现**：由于HLS基于HTTP协议，实现相对简单，并且容易与现有的Web技术集成。

HLS工作流程如下：

1. **媒体切片**：服务器将媒体内容分割成一系列小的、连续的TS（MPEG-2 Transport Stream）文件，这些文件通常是几秒钟的长度。
2. **索引文件（M3U8）**：服务器生成一个索引文件（通常是M3U8格式），列出所有媒体片段的URL。这个文件称为播放列表，包含了媒体片段的顺序和位置。
3. **客户端请求**：客户端请求播放列表（M3U8文件），并根据播放列表中的URL逐个请求媒体片段。
4. **播放和缓存**：客户端下载并播放媒体片段，同时可以缓存一定数量的片段以应对网络波动。

一个典型的HLS播放列表文件（M3U8）的示例如下：

```
#EXTM3U
#EXT-X-VERSION:3
#EXT-X-TARGETDURATION:10
#EXT-X-MEDIA-SEQUENCE:0
#EXTINF:10.0,
http://example.com/segment0.ts
#EXTINF:10.0,
http://example.com/segment1.ts
#EXTINF:10.0,
http://example.com/segment2.ts
```

这个播放列表文件指示客户端依次请求和播放`segment0.ts`、`segment1.ts`和`segment2.ts`，每个片段长度为10秒。

HLS在流媒体行业中得到广泛应用，特别是在直播和视频点播服务中，成为了许多视频传输解决方案的基础。

+ HTTP Live Streaming(HLS)是苹果公司实现的基于HTTP的流媒体传输协议，可实现流媒体的直播和点播，主要应用于IOS系统。HLS点播是分段HTTP点播，不同在于它的分段非常小。要实现HLS点播，重点在于对媒体文件分段，目前有不少开源工具可以使用。
+ 相对于常见的流媒体直播协议，HLS直播最大的不同在于，直播客户端获得的并不是一个完整的数据流，HLS协议再服务器端将直播数据流存储为连续的，很短时长的媒体文件(MPEG-TS格式)。而客户端则不断的下载并播放这些小文件，因为服务器总是会将最新的直播数据生成新的小文件，这样客户端只要不停的按顺序播放从服务器获取到的文件，就实现了直播。由此可见，基本上可以认为，HLS是以点播的技术方式实现直播。由于数据通过HTTP协议传输，所以完全不用考虑防火墙或者代理的问题，而且分段文件的时长很短，客户端可以很快的选择和切换码率，以适应不同带宽条件下的播放。不过HLS的这种技术特点，决定了它的延迟一般总是会高于普通的流媒体直播协议。