## 主站和从站

+ 参考：
  + `https://blog.csdn.net/qq923433160/article/details/83781812`

---

+ 主站的实现可采用嵌入式和PC机两种方式，均需配备标准以太网MAC控制器，传输介质可使用100BASE-TX规范的5类UTP线缆。
+ EtherCAT从站设备除了具备通信功能外，还需具备对从站设备的控制功能。常见的从站设备有I/O端子、伺服设备、微处理器等。

+ EtherCAT主站运行需具备以下几个基本功能：
  + 读取从站设备描述XML文件并对其进行解析，获取其中配置参数
  + 捕获和发送EtherCAT数据帧，完成EtherCAT子报文解析、打包等
  + 管理从站设备状态，运行状态机，完成主从站状态机设置和维护
  + 可进行非周期性数据通信，完成系统参数配置，处理通讯过程中突发事件
  + 实现周期性过程数据通信，实现数据实时交换，实时监控从站状态，从站反馈 信号实时处理等功能。

## 控制卡

+ 参考：
  + `https://www.cnblogs.com/cariohu/p/15508175.html`

### 控制卡分类

+ 控制器或者控制卡的性能主要取决于控制算法，不同厂家控制卡的性能差别可能非常大。
+ 目前常见工业应用中比较高端的有以色列ACS，美国Aerotech，这是属于第一梯队的，其他国外的流行品牌还有elmo、PMAC、Galil、欧姆龙等。国内的有固高、雷赛、正运动、柏楚等，与国外产品相比仍然有一定差距，但也在不断突破。

+ 根据控制器传递命令给驱动器的方式，可以分为：总线型、模拟量型、PWM型、脉冲型控制卡。
+ 目前，总线型控制卡是最主流的，各大厂家的口号都是一网到底，这个网就是指的总线，就是通过一根总线把所有模块都接上去，确实方便。其他三种类型控制卡也有各自的特色，所以都并行存在于主流市场

### 总线控制卡

+ 常见的总线接口有，**EtherCAT**、CAN、Modbus、Profinet、EPA、SERCOS-Ⅲ等。
+ 总线有这么多种，他们之间是否有联系，又有哪些区别呢？这是我们学习总线之前需要搞清楚的问题，不然总是会心里没底，或者是错误的把总线混搭一起，这些是新手的必经之路。

+ 要想搞清楚不同总线之间的区别与联系，我们就得从总线通讯的组成或者是框架去看
  + 通讯的概念出现的很早，早期的电话电报就是一种通讯方式，但工业上的通讯应用都是OSI七层模型。OSI(open system interconnect)即开放系统的互连，这个是二十世纪七十年代的产物，当时就是为了解决各系统之间通讯的问题。
  + OSI七层模型图，从模型中我们可以看到，通讯最终是转化为比特流发送出去，我们说的通讯速率就是比特流的速率，比如百兆网络100Mbit/s。比特流的传输载体是物理层，是我们看的见摸得着的线缆以及接口芯片等。
  + 物理层往上是数据链路层，数据链路层的职责是负责将具体的数据转化成比特流，然后通过物理层的硬件发送。可以简单理解为，硬件的编码与解码，比如要发送数字8，那么数字8的比特流高低电平是怎样的；当收到一串比特流后，应该转换为哪个数字，这个就靠数据链路层完成的，数据链路层也是硬件。 
  + 数据链路层再往上，还有五层。这五层都有一个特点，他们都是软件层，是运行在处理器上的软件代码，这五层完成数据报的解析，编组，归类，最终到显示。
+ 当我们用因特网看视频时，这些层就在周而复始发送请求，解析数据，并最终刷新到显示界面。这五层搞起来确实有点复杂，有些时候其实是不需要的，比如我们知道数据的具体含义，我们就不需要再去分组整理数量，直接使用即可，工业通讯应用正是符合这个特点。
+ 尤其是针对运动控制或者过程控制总线，层太多不仅没用，反而会增加成本，并且运动控制或者过程控制这种专用总线上数据的含义都是严格一一对应的，不需各种分组分段解析啥的。所以，将五层压缩为一层，叫应用层。

+ 物理层，数据链路层，应用层都有各自的功能，三层功能没有重叠部分。
+ 发送工作流程是当数据到达后应用层后把数据放到对应的存储区，数据需要发送时到对应区域取出数据，交给数据链路层，比特流经物理层发送出去；
+ 接收工作流程就是反过来，物理层上的比特流被数据链路层解析为正确的数值，放到对应的存储区域，应用层需要数据的时候取走数据即可。
+ 所以，运动控制或者过程控制总线，这种专用总线都是三层模型，三层模型的功能：
  + 应用层：搬运数据，完成控制功能
  + 数据链路层：承上启下，生成比特流，以及解析比特流
  + 物理层：比特流传输载体

+ 当我们接触或者学习新的总线时，主要是搞清楚总线的框架，即这三层的情况是怎样的。只有搞清楚了这三层，你才不会被各种新鲜名词所吓倒，你才不会去随便混搭总线。搞清楚了总线通讯模型后，我们看下当前最火的两个总线，EtherCAT和CAN总线。
+ 为什么EtherCAT和CAN总线这么火？

#### CAN总线

+ 首先，是CAN总线起步早，博世公司1986年推出，当时主要是面向汽车行业。注意这里我说的是CAN总线，不是CANOPEN总线，CANOPEN只是基于CAN总线的应用层协议，汽车行业基于CAN总线的应用层协议是J1939。经过汽车行业的多年应用，大家发现这个总线的优点很多，速度快，1Mbit在现在看确实不快，但在那个年代还是非常牛的；有COB-ID，有仲裁机制，高优先级的数据可以先传输，低优先级是数据后发送，排队的数据在总线空闲的时候会自动发送，无需人为干预；差分传输，数据传输可靠性高；理论上可以在总线上挂任意多节点；成本低，几块钱的MCU就自带CAN控制器，现在一般同时支持CAN2.0A和2.0B。
+ 既然CAN总线有这么多优点，那就得充分利用上，紧接着有个组织叫CIA(CAN in Automation)起草了基于CANopen的设备及通讯子协议定义DS 301(Draft Standard 301)，也就是我们经常说的301协定。DS301只是CANopen的一个基础规范，具体到细分领域有，I/O模组的DS401，运动控制的DS402。讲到这里就出现了我们期盼已久的CANopen协议，之所以火就是因为起步早，又赶上了电机运动控制的蓬勃发展时期，靠谱好用，便宜，易上手。其实基于CAN总线的应用层协议还有北美船舶行业通讯协议，广州周立功公司的iCAN，但这个两个协议都不在运动控制系统中出现。其实协议就是这么简单，你也可以基于CAN总线创立自己的协议，只要有人用，你就很了不起。
+ 这里简单讲下CANopen DS402的相关知识，方便我们后面的理解。DS402里面有一些概念，对象字典，Node-ID，COB-ID，SDO，PDO，NMT，Heartbeat，状态机，Master，Slave，我们都简单介绍下。
  + DS402中规定网络中各设备是主从关系，即Master-Slave模式，原则上只能有一个Master，负责整个网络的管理。其实CAN总线上的都是节点，没有主从的概念，主从的概念是在DS402中规定的，这一点我们要清楚。
  + **对象字典我们可以理解为寄存器表**，只不过DS402已经规定了这个寄存器表的组织结构，包括一部分地址必须给协议使用，如0x6040,0x6041这些都是规定好的。有了对象字典我们就知道每个对象代表的是什么意思，每个厂家都按这个去设计。传输数据的时候我们得知道这个是哪个从站设备的数据，就需要有个Node-ID，简单说就是设备的编号。
  + 假如不同设备同时要传输同样对象字典的数据，那我们该怎样区分呢？这个时候就有COB-ID，COB-ID是对应的编码加上Node-ID，如0x600表示SDO读，对应节点1组合后的COB-ID就是0x600+0x01=0x601，节点2则为0x602，以此类推。这样我们就可以通过COB-ID来直接操作数据了，而无需关心是哪个节点的，如果数据同时需要发送，那么总线的仲裁机制就会起作用，COB-ID越小的优先级越高，优先发送，等待的数据在前面的数据发送完之后会自动重发。

+ 数据的传输分为两种
  + 一种是SDO，就是有问才有答，查询一次回复一次，类似服务生一样。
  + 另一种是PDO，叫过程数据，提前配置好了数据的传输方式后数据就会自动上传，如可以设置数据的最小间隔时间，同步、异步、RTR等。
+ SDO和PDO都是为了传输数据，但PDO传输的是过程数据，更精简，传输数据的效率会更高，**如循环同步模式肯定是PDO传输数据**
+ NMT是网络管理的意思，主站负责管理整个网络，如各节点的状态切换等。
+ 状态机是控制节点切换的，如在非使能状态到使能状态应该怎么响应，这个是状态机管理的。
+ 最后一个是Hearbeat，当然也有NodeGuarding，这两个都是反馈节点的状态。当总线在工作的时候我们得知道节点是否还在线，Hearbeat就类似我们的心跳，间隔多长时间必须收到一次心跳，超出设定时间没收到心跳则表示该节点已死亡。
+ NodeGuarding是另外一种监测方式，它有主站和从站的互动，这是不同于Hearbeat的，就是主站要发命令给从站，从站也要回应命令，也是要求在规定的时间内，目前Hearbeat用的更多一些。

#### EtherCAT总线

+ EthterCAT的字面意思就是以太网自动化控制技术。简单点说就是基于以太网，完成自动化控制功能，但肯定与普通以太网还是有区别的。
+ 他们的传输介质是一样的，都是RJ45网口+网线，但EtherCAT网络的数据链路层芯片是专门设计的，其目的是为了提高总线的性能。比如，增加了DC同步单元，数据自动转发，还有FMMU单元，SM单元，详细的情况可以去查询相关资料。
+ DC同步单元的时钟都是ns为单位，可以满足非常高的同步要求，然后以太网的通讯速度又非常快，现在1000Mbit/s都已经不是事了，在每个传输周期可以有非常大量的数据交互。这些都是基于硬件的，做应用的人可以不用关心，我们还是讲讲上层协议。
+ 对硬件感兴趣的可以参考AX58100、ET1100芯片的数据手册，山东大学李正军教授的《EtherCAT工业以太网应用技术》非常不错，里面有详细的介绍，值得一看，这里就不展开讲了。

+ 基于EtherCAT总线的应用层协议有FoE、CoE、SoE、EoE、AoE、VoE，各个协议的具体描述如下表2-2：
  + FoE, File over EtherCAT     --  在EtherCAT总线上传输文件的协议
  + CoE, CANopen over EtherCAT  --  在EtherCAT总线上执行CANopen协议
  + SoE, SERCOS over EtherCAT   --  在EtherCAT总线上执行SERCOS协议
  + EoE, Ethernet over EtherCAT --  在EtherCAT总线上执行Ethernet协议
  + AoE  --  访问底层现场总线的从站设备的对象字典，如对连接到EtherCAT-CAN网关设备的CAN从站
  + VoE  --  供应商自定义协议，基于邮箱
+ 这些都是运行在EhterCAT总线基础上的应用层协议，各个协议分管与自己相关的工作。
+ 我们现在常用的EtherCAT伺服驱动器，说白了就是把CANopen应用层协议搬到了EtherCAT总线之上。由于EhterCAT总线的高传输速度，所以这个时候可以有更高的控制信号频率，就会有更好的控制效果。
+ 讲到这里，我们可以发现，同样的协议可以在不同的总线上，同样的总线也可以用不同的协议。所以，**当我们讨论总线的时候也要讨论总线的应用层协议**，即我们前文提到的三层模型，只有三层模型都一样的系统才能完美对接。对总线就介绍这么多，原理都是一样的，其他总线可以按照这个方法学习，事半功倍。
+ 有了这样可靠性高，同步性好，控制频率可以很高的总线，现在控制指令的频率到8Khz已经不是问题了。控制卡的指令就可以很快很准的发送给总线上的驱动单元，最终达到好的控制效果。总线型控制系统的所有指令，位置反馈，指示状态，错误代码等等，都是由通讯来完成交互的，这一点和传统的控制方式有很大的区别。

## 驱动支持的各种模式详解

+ 早期非总线的驱动器一般是支持三个工作模式，位置模式，速度模式和电流模式，这个都比较简单，配置好模式，给对应的指令即可工作。
+ 这些模式一般都可以接收模拟量和PWM命令，位置模式还可以接收脉冲命令，这个就不展开讲了，参对应驱动的手册即可知道特定模式支持哪些类型的命令输入。这种驱动最大的缺点就是接线复杂，控制卡离驱动不能太远，还需要考虑控制线缆抗干扰，不利于分布式现场的情况。这种一般是应用于小型独立式设备，设备相对比较小，线缆不会太长，干扰问题比较好解决。

+ 随着总线型驱动器的出现，驱动器的工作模式增加了好几个。没有特殊说明的话，这里的总线指的是CAN总线和EtherCAT总线。
+ 基于这两个总线的驱动器一般都支持如表3-1所示的模式，当然还有PVT模式，IPM模式，但这些现在已经都不太常见了，有需要的可以查阅相关资料。   
  + HM   --  回零模式
  + PVM  --  带规划的速度模式
  + PPM  --  带规划的位置模式
  + CSP  --  循环同步的位置模式
  + CSV  --  循环同步的速度模式
  + CST  --  循环同步的转矩模式

+ HM模式是回零模式，驱动器已经内置好了各种回零方式。如先找负限位再找index方式；用限位作为回零原点方式；碰到硬限位回零方式等等。这些回零方式的程序已经在驱动器内部实现好了，我们只需要配置好相关参数，启动回零即可，回零过程都是驱动器内部程序完成。同时，也有状态变量可以监控当前的回零状态，是否完成，是否有报错等。
+ PVM和PPM是带规划的速度和位置模式，规划的意思就是根据用户设定的加减速度去启动和停止运动。这个两个模式很简单，有点像非总线伺服驱动器的速度模式和位置模式，这里不详细介绍了。
+ 我们重点介绍下循环同步模式，循环同步的意思就是以一个固定的时间间隔，周而复始的发送数据和同步指令。为什么要搞这个玩法呢？PVM PPM不香吗？这是我们学习新知识前需要考虑的问题，搞清楚了背景，理解起来会更有帮助。
  + 我们先想下，控制卡+非总线伺服驱动器是怎样实现多轴同步的，是多个驱动的控制命令在同一个DSP中运算，这样时间上就不会有偏差，确保每次都是几乎同一时间把指令发送给驱动器。如果是多个DSP有各自控制的驱动器，这些驱动器之间做同步运动，比如插补，效果都会差于一个DSP内部轴同步的效果，除非你把多个DSP任一时刻都同步起来，同样的时间做同样的运算，这样也许会是一样的效果。
  + 而我们这里说的循环同步就是干这个事情，总线型驱动器与控制卡或者叫master之间的连接只有一条通讯线，无论这条通讯线是CAN总线的半双工，或是EtherCAT总线的全双工，再加100Mbit/s的带宽，数据传输总会有先后顺序，这个事实没法改变。假如总线上的所有驱动器都以收到指令数据的那一刻去执行指令，那么驱动器之间就无法很好同步了。
  + 那么应该怎么办呢？人是真的聪明，总会想办法去解决问题，天才的工程师提出了一个解决方案。所有驱动器都先收指令数据，但不要立马执行，等待一个命令再执行，这个就是同步命令，这样就完美的解决了总线上数据传输有先后顺序的问题。大家都是先把数据准备好，然后等待同步命令，这个就好比百米赛跑一样，大家都先准备好，等待发令枪再跑，这样就是公平的。至于最终跑的结果怎样看个人水平，驱动器最终执行的效果怎样也是看驱动器的性能，感觉这个启发真是源于生活，最终又服务于生活。

+ 讲完什么是循环同步后，我们看下循环同步的三个模式到底是啥。
+ 首先说CSP，循环同步的位置模式：
  + 这个模式接收的是控制卡下发的位置指令，但这个位置不是随便发的，需要根据位置轨迹解算为一个一个点，这个是需要上位机解算的。
  + 上位解算点的这个过程叫粗插，就是粗线条的给出一些点，这些点不是驱动伺服环路能直接使用的，驱动器在接收到这些点后需要再进行精插，最终变成伺服环路能直接执行的位置点。
  + 精插是相对于粗插来说的，精插是以伺服周期为基准时间单位，精细的将轨迹分成很多个位置点，形成一个位置表，每个伺服周期去这个表中取一个值执行即可。
  + 我们以一个T形加减速，有匀速过程的点到点运动为例来剖析CSP模式的细节。如图3-15，是一个点到点运动，位置—时间和速度—时间关系图，加速和减速阶段的轨迹是曲线，匀速阶段是直线。再看下位置图中的插值点，这些点之间的时间是均匀间隔的，每到一个时间点位置轨迹与时间轴围成一个面积，这个面积就是我们在CSP模式发送给驱动器的位置指令，随着时间的增加，这个面积会越来越大。
  + 只要这些插值点是均匀的，指令发送的时间是准确的，满足这两个条件的情况下，电机的转动必然是平滑的。这两个条件中的任何一个不满足，电机的转动都是会顿挫的。
  + 如果插值点不均匀，比如有的时候插值点是间隔10ms，有的时候插值点是20ms。最明显的结果就是电机运动不平滑，那么为什么会不平滑呢？我们知道位置轨迹连续则位置轨迹的导数或者叫曲线的曲率才不会有突变，位置轨迹导数对应着的是速度，速度不突变则电机运转平稳。如果我的插值点时间突然增加或者缩短，则必然会导致曲率突变，这是上位在解算轨迹点需要注意的问题。
  + 尤其是任意轨迹曲线，曲率的突变非常厉害，即使在均匀的插值情况下，电机运转可能都会抖动明显。所以，对任意曲线的插值，还有需要针对锐角以及曲率突变的点做优化，比如用圆弧过度锐角，或者降低运动速度。
  + 到这里我们对CSP的整个细节基本讲完了，在使用过程中，我们还需注意循环同步指令的周期以及指令到达是否准时。指令的周期不应过短，要让驱动器有精插的空间，比如驱动伺服环路400us，那么你就不要给低于400us的同步周期，当然很多驱动也不支持这么短的同步周期，即使支持也不要这样给。同步指令要有硬时性，或者实时性好，我们一般以us为单位，尽可能的准时，指令不准时同样会导致电机运动的时候顿挫严重，甚至驱动器报错。
  + 到这里我们讲完了整个CSP模式的要点，在使用CSP模式的时候如果电机运转不平滑，该怎样去找问题，这才是我们要关注的核心。看到这里应该有一种豁然开朗的感觉，就证明你完全理解了循环同步位置模式的精髓。

+ 讲完CSP模式，后面的CSV和CST模式就简单了，我们先看看CSV模式：
  + CSV是循环同步的速度模式，控制卡下发的是速度指令，这个速度指令和位置指令一样，也不是随便给的。需要对速度曲线进行插值，解算每个周期应该给驱动的速度指令，对位置轨迹求导数就是速度，也就有了速度曲线。
  + 同CSP一样，控制卡或者上位也只是粗插，伺服环路还会根据指令和周期的时间进行精插，最终就变成了伺服环路可以执行的指令。
  + 同样，CSV模式对指令的实时性要求同CSP一样，不准时的指令就会导致电机运转的时候顿挫，顿挫就是速度突变造成的，分析方法和CSP模式一样，这里不再赘述

+ 看完CSV，我们再看看CST：
  + 这个模式和前面两个的共同之处是都为循环同步模式，不同之处是CST模式的指令直接被伺服环路所用，中间没有精插的过程。由于这个不同，CST模式的指令实时性不好的时候我们也很难发现，因为CST模式对应的是电机的电流，电流对应的是电机的输出转矩，电流的突变就是转矩的突变。
  + 转矩的是突变对应三种情况：
    + 一种是电机输出转矩大于负载转矩，电机加速
    + 另一种是电机输出转矩等于负载转矩，电机还是静止；
    + 甚至是电机输出转矩小于负载转矩，电机被负载拖动，运动控制中这种一般很少
  + 指令实时性不好很难被发现，并不是说CST模式对指令实时性没有要求，既然叫循环同步模式，那就是有这个要求。

+ 总结下三个循环同步模式，循环同步模式的出现，使得我们对任意轨迹的指令规划变得非常方便，就是对曲线插值，获得各时刻应该下发的指令。它使我们更加靠近了伺服环路的工作原理，伺服环路其实也是一直在插，不断的解算各个伺服周期的命令，然后算法以读表的方式不断的读取各个周期的指令。
+ 讲到这里，整个驱动器的相关知识就介绍完了。简单总结就是，驱动器有硬件和固件两部分，硬件部分负责控制电机的换向，电流调节，反馈信号采集等；固件部分或者叫软件部分，则是通过硬件的各种反馈信号，周而复的运算，并将运算结果输出到硬件。其实整个伺服系统工作的过程，就是一个不断纠偏的过程，大了就小点，小了就大点，没有真正的静止，一直运动，只是在几个脉冲来回移动，这才是伺服系统的精髓，没有真正的静止。